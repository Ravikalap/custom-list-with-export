<!DOCTYPE html>
<html>
<head>
    <title>custom-list-with-export</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var e=window.Ext4||window.Ext;e.define("Niks.Apps.listExporter.app",{extend:"Rally.app.App",componentCls:"app",integrationHeaders:{name:"niks-apps-radial-density"},config:{defaultSettings:{includeStories:!0,includeDefects:!1,includeTasks:!1,includeTestCases:!1,usePreliminaryEstimate:!0,hideArchived:!1,sizeStoriesByPlanEstimate:!1,sortSize:!1}},WorldViewNode:{Name:"World View",dependencies:[],local:!1,record:{data:{FormattedID:"R0"}}},statics:{MAX_THREAD_COUNT:32},_defectModel:null,_userStoryModel:null,_taskModel:null,_testCaseModel:null,_portfolioItemModels:{},_storyStates:[],_defectStates:[],_taskStates:[],_tcStates:[],_piStates:[],_nodes:[],_recordsToProcess:[],_runningThreads:[],_lastThreadID:0,itemId:"rallyApp",STORE_FETCH_FIELD_LIST:["Attachments","Blocked","Children","Defects","DisplayColor","DragAndDropRank","FormattedID","Iteration","LastVerdict","Name","ObjectID","OrderIndex","Ordinal","Owner","Parent","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","PlanEstimate","PortfolioItemType","Predecessors","PredecessorsAndSuccessors","PreliminaryEstimate","Project","Ready","Release","Requirement","ScheduleState","State","Successors","Tasks","TestCases","UserStories","WorkProduct","Workspace"],EXPORT_FIELD_LIST:["Attachments","Name","Owner","PreliminaryEstimate","Parent","Project","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","PredecessorsAndSuccessors","State","Milestones"],onSettingsUpdate:function(e){},getSettingsFields:function(){return[{name:"hideArchived",xtype:"rallycheckboxfield",fieldLabel:"Do not show archived",labelALign:"middle"},{name:"includeStories",xtype:"rallycheckboxfield",fieldLabel:"Include User Stories in Export",labelALign:"middle"},{name:"includeDefects",xtype:"rallycheckboxfield",fieldLabel:"Include Defects Stories in Export",labelALign:"middle"},{name:"includeTasks",xtype:"rallycheckboxfield",fieldLabel:"Include Tasks in Export",labelALign:"middle"},{name:"includeTestCases",xtype:"rallycheckboxfield",fieldLabel:"Include TestCases in Export",labelALign:"middle"}]},timer:null,_redrawTree:function(){gApp.down("#loadingBox")&&gApp.down("#loadingBox").destroy(),clearTimeout(gApp.timer),gApp._nodeTree&&(_.each(gApp._nodeTree.descendants(),function(e){e.card&&e.card.destroy()}),d3.select("#tree").remove(),d3.select("#depsOverlay").remove(),gApp._nodeTree=null),gApp._enterMainApp()},_enterMainApp:function(){if(gApp._nodes.length){var e=gApp._createTree(gApp._nodes);gApp._nodeTree=e,gApp._refreshTree(viewBoxSize)}},_getUserStoryModel:function(){var t=e.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",context:{workspace:gApp.getContext().getWorkspace()},success:function(e){gApp._userStoryModel=e,_.each(e.getField("ScheduleState").attributeDefinition.AllowedValues,function(e,t){gApp._storyStates.push({name:e.StringValue,value:t})}),t.resolve(e)},failure:function(e){t.reject(null)}}),t.promise},_getDefectModel:function(){var t=e.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Defect",context:{workspace:gApp.getContext().getWorkspace()},success:function(e){gApp._defectModel=e,_.each(e.getField("ScheduleState").attributeDefinition.AllowedValues,function(e,t){gApp._defectStates.push({name:e.StringValue,value:t})}),t.resolve(e)},failure:function(e){t.reject(null)}}),t.promise},_getTaskModel:function(){var t=e.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Task",context:{workspace:gApp.getContext().getWorkspace()},success:function(e){gApp._taskModel=e,_.each(e.getField("State").attributeDefinition.AllowedValues,function(e,t){gApp._taskStates.push({name:e.StringValue,value:t})}),t.resolve(e)},failure:function(e){t.reject(null)}}),t.promise},_getTestCaseModel:function(){var t=e.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"TestCase",context:{workspace:gApp.getContext().getWorkspace()},success:function(e){gApp._testCaseModel=e,_.each(e.getField("LastVerdict").attributeDefinition.AllowedValues,function(e,t){gApp._tcStates.push({name:e.StringValue,value:t})}),t.resolve(e)},failure:function(e){t.reject(null)}}),t.promise},_exportCSV:function(e){Rally.data.ModelFactory.getModel({type:"TestCase",context:{workspace:gApp.getContext().getWorkspace()},success:function(e){gApp._testCaseModel=e,_.each(e.getField("LastVerdict").attributeDefinition.AllowedValues,function(e,t){gApp._tcStates.push({name:e.StringValue,value:t})})}})},_loadStoreLocal:function(){var t=gApp.down("#piType");e.create("Rally.data.wsapi.Store",{model:"portfolioitem/"+t.rawValue.toLowerCase(),autoLoad:!0,fetch:gApp.STORE_FETCH_FIELD_LIST,pageSize:2e3,limit:1/0,sorters:[{property:"DragAndDropRank",direction:"ASC"}],listeners:{load:function(e,t,r){gApp._nodes=[gApp.WorldViewNode],t.length>0?(gApp.setLoading("Loading artefacts...."),gApp._getArtifacts(t)):Rally.ui.notify.Notifier.show({message:"No Artefacts to fetch"})}}})},launch:function(){gApp=this,this.add({xtype:"container",itemId:"displayBox",items:[{xtype:"container",itemId:"headerBox",layout:"hbox",items:[{xtype:"rallyportfolioitemtypecombobox",itemId:"piType",fieldLabel:"Choose Portfolio Type :",labelWidth:150,allowClear:!0,margin:"5 0 5 20",storeConfig:{fetch:["DisplayName","ElementName","Ordinal","Name","TypePath","Attributes"],listeners:{load:function(e){gApp._typeStore=e}}},listeners:{select:function(e){gApp._piModelsValid(e.getRecord())},scope:gApp}}]}]})},_piModelsValid:function(t){var r="string"==typeof t.get("_type")?[t.get("TypePath").toLowerCase()]:["hierarchicalrequirement","defect"];e.create("Rally.data.wsapi.TreeStoreBuilder").build({models:r,enableHierarchy:!0,remoteSort:!0,fetch:["FormattedID","Name"]}).then({success:function(e){gApp._addGridboard(e,r)},scope:this})},_addGridboard:function(e,t){this.gridboard=gApp.down("#displayBox").add({xtype:"rallygridboard",context:gApp.getContext(),modelNames:t,toggleState:"grid",plugins:["rallygridboardaddnew",{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:gApp.getContext().getScopedStateId("filters-1"),modelNames:t,inlineFilterPanelConfig:{quickFilterPanelConfig:{whiteListFields:["Tags","Milestones"],defaultFields:["ArtifactSearch","Owner","ModelType","Milestones"]}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:t},{ptype:"rallygridboardactionsmenu",menuItems:gApp._getExportMenuItems(),buttonConfig:{iconCls:"icon-export"}}],cardBoardConfig:{attribute:"ScheduleState"},gridConfig:{store:e,columnCfgs:["Name"]},height:gApp.getHeight()-gApp.down("#headerBox").getHeight()})},_getExportMenuItems:function(){return[{text:"Export to CSV",handler:gApp._getGridArtifacts,scope:gApp}]},_findIdInTree:function(e){return _.find(gApp._nodeTree.descendants(),function(t){return t.data.record.data.FormattedID===e})},_threadCreate:function(){var e=worker.toString();e=e.substring(e.indexOf("{")+1,e.lastIndexOf("}"));var t=new Blob([e],{type:"application/javascript"}),r=new Worker(URL.createObjectURL(t)),a={lastCommand:"",worker:r,state:"Initiate",id:++gApp._lastThreadID};gApp._runningThreads.push(a),r.onmessage=gApp._threadMessage,gApp._giveToThread(a,{command:"initialise",id:a.id,fields:gApp.STORE_FETCH_FIELD_LIST.concat([gApp._getModelFromOrd(0).split("/").pop()])})},_checkThreadState:function(e){return e.state},_wakeThread:function(e){"Asleep"===gApp._checkThreadState(e)&&(e.lastMessage="wake",e.worker.postMessage({command:e.lastMessage}))},_checkThreadActivity:function(){for(;gApp._runningThreads.length<gApp.self.MAX_THREAD_COUNT;)gApp._threadCreate();_.each(gApp._runningThreads,function(e){gApp._recordsToProcess.length>0&&"Asleep"===e.state&&gApp._processRecord(e,gApp._recordsToProcess.pop())})},_giveToThread:function(e,t){e.state="Busy",e.worker.postMessage(t)},_processRecord:function(e,t){e.lastCommand="readchildren";var r={command:e.lastCommand,objectID:t.get("ObjectID"),hasChildren:t.hasField("Children")&&t.get("Children").Count>0?Rally.util.Ref.getUrl(t.get("Children")._ref):null,hasDefects:gApp.getSetting("includeDefects")&&t.hasField("Defects")&&t.get("Defects").Count>0?Rally.util.Ref.getUrl(t.get("Defects")._ref):null,hasStories:gApp.getSetting("includeStories")&&t.hasField("UserStories")&&t.get("UserStories").Count>0?Rally.util.Ref.getUrl(t.get("UserStories")._ref):null,hasTasks:gApp.getSetting("includeTasks")&&t.hasField("Tasks")&&t.get("Tasks").Count>0?Rally.util.Ref.getUrl(t.get("Tasks")._ref):null,hasTestCases:gApp.getSetting("includeTestCases")&&t.hasField("TestCases")&&t.get("TestCases").Count>0?Rally.util.Ref.getUrl(t.get("TestCases")._ref):null};gApp._giveToThread(e,r)},_getGridArtifacts:function(){gApp._getArtifacts(gApp.down("rallygridboard").getGridOrBoard().getStore().getTopLevelNodes())},_getArtifacts:function(e){gApp._nodes=gApp._nodes.concat(gApp._createNodes(e)),_.each(e,function(e){gApp._recordsToProcess.push(e)}),gApp._checkThreadActivity()},_threadMessage:function(t){if("Data"===t.data.reply){var r=[];_.each(t.data.records,function(t){switch(t._type){case"HierarchicalRequirement":r.push(e.create(gApp._userStoryModel,t));break;case"Defect":r.push(e.create(gApp._defectModel,t));break;case"Task":r.push(e.create(gApp._taskModel,t));break;case"TestCase":r.push(e.create(gApp._testCaseModel,t));break;default:r.push(e.create(gApp._portfolioItemModels[t._type.split("/").pop()],t))}}),gApp._getArtifacts(r)}var a=_.find(gApp._runningThreads,{id:t.data.id});a.state="Asleep",gApp._recordsToProcess.length>0&&gApp._processRecord(a,gApp._recordsToProcess.pop()),gApp._allThreadsIdle()&&(gApp.setLoading("Exporting CSV...."),gApp._exportCSV())},_allThreadsIdle:function(){return _.every(gApp._runningThreads,function(e){return"Asleep"===e.state})},_nodeTree:null,_refreshTree:function(e){gApp._nodeTree.sum(function(e){var t=0;return e.record.data._ref&&(t=e.record.isPortfolioItem()?gApp.getSetting("usePreliminaryEstimate")?e.record.get("PreliminaryEstimateValue"):e.record.get("LeafStoryCount"):gApp.getSetting("sizeStoriesByPlanEstimate")?e.record.get("PlanEstimate"):e.record.get("DirectChildrenCount")),t||1}),gApp.getSetting("sortSize")&&gApp._nodeTree.sort(function(e,t){return t.value-e.value});var t=partition(gApp._nodeTree);d3.select("#tree").selectAll("node").data(t.descendants()).enter();gApp.setLoading(!1)},_createNodes:function(e){var t=[];return _.each(e,function(e){var r=gApp.getContext().getProjectRef()===e.get("Project")._ref;t.push({Name:e.get("FormattedID"),record:e,local:r,dependencies:[]})}),t},_findNodeByRef:function(e){return _.find(gApp._nodes,function(t){return t.record.data._ref===e})},_findParentType:function(e){for(var t=null,r=0;r<gApp._typeStore.totalCount;r++)if(e.data._type===gApp._typeStore.data.items[r].get("TypePath").toLowerCase()){t=gApp._typeStore.data.items[r].get("Ordinal");break}if(t+=1,r>=gApp._typeStore.totalCount)return null;var a=_.find(gApp._typeStore.data.items,function(e){return e.get("Ordinal")===t});return a&&a.get("TypePath").toLowerCase()},_findNodeById:function(e,t){return _.find(e,function(e){return e.record.data.FormattedID===t})},_getTypeList:function(e){var t=[];return _.each(gApp._typeStore.data.items,function(r){r.data.Ordinal<=(e||0)&&t.push({type:r.data.TypePath.toLowerCase(),Name:r.data.Name,ref:r.data._ref,Ordinal:r.data.Ordinal})}),t},_highestOrdinal:function(){return _.max(gApp._typeStore.data.items,function(e){return e.get("Ordinal")}).get("Ordinal")},_getModelFromOrd:function(e){var t=null;return _.each(gApp._typeStore.data.items,function(r){e===r.get("Ordinal")&&(t=r)}),t&&t.get("TypePath")},_getOrdFromModel:function(e){var t=null;return _.each(gApp._typeStore.data.items,function(r){e===r.get("TypePath").toLowerCase()&&(t=r.get("Ordinal"))}),t},_findParentNode:function(e,t){var r=t.record;if("R0"===r.data.FormattedID)return null;var a=gApp._getModelFromOrd(0).split("/").pop(),n=null;r.isPortfolioItem()?n=r.data.Parent:r.isUserStory()?n=r.data.Parent?r.data.Parent:r.data[a]:r.isTask()?n=r.data.WorkProduct:r.isDefect()?n=r.data.Requirement:r.isTestCase()&&(n=r.data.WorkProduct);var o=null;if(n)o=gApp._findNodeByRef(n._ref);else{var i=gApp._findParentType(r);if(i){var s="/"+i+"/null";o=gApp._findNodeByRef(s)}}return o||gApp._findNodeById(e,"R0")},_createTree:function(e){var t=d3.stratify().id(function(e){return e.record&&e.record.data.FormattedID||null}).parentId(function(t){var r=gApp._findParentNode(e,t);return r&&r.record&&r.record.data.FormattedID})(e);return t.sum(function(e){return e.Attachments?e.Attachments.Size:0}),t.each(function(e){e.ChildAttachments={},e.ChildAttachments.Size=e.value}),t.sum(function(e){return e.Attachments?e.Attachments.Count:0}),t.each(function(e){e.ChildAttachments.Count=e.value}),console.log("Created Tree: ",t),t}})}();
                Ext.define("Niks.Apps.TreeExporter",{dateFormat:"Y-m-d",inheritableStatics:{XmlFileHeader:'<?xml version="1.0"?>',XmlFileExtension:".xml.txt"},config:{},constructor:function(t){this.mergeConfig(t),this.callParent(arguments)},_downloadFiles:function(t){if(t.length){var e=t.pop(),n=t.pop(),i=t.pop(),a="<a href='"+n+","+encodeURIComponent(e)+"' download='"+i+"'></a>";Ext.DomHelper.insertAfter(window.document.getElementsByClassName("app")[0],a).click(),this._downloadFiles(t)}},exportCSV:function(t){var e=this._getCSV(t);e=e.replace(/\'/g,""),this._downloadFiles(["export.csv","data:text/csv;charset=utf8",e])},_XMLIndent:function(t,e,n,i){for(var a="\n",r=0;r<t;r++)a+="\t";if(a+="<"+e+">",a+=i,!n)for(a+="\n",r=0;r<t;r++)a+="\t";return a+="</"+e+">"},_escapeForCSV:function(t){return(t=""+t).match(/,/)&&(t=t.match(/"/)?t.replace(/,/g,""):'"'+t+'"'),t},_getFieldText:function(t){return null===t||void 0===t?"":t._refObjectName&&!t.getMonth?t._refObjectName:t instanceof Date?Ext.Date.format(t,this.dateFormat):t},_getFieldTextAndEscape:function(t){var e=this._getFieldText(t);return this._escapeForCSV(e)},fixedColumnCount:function(t){return _.filter(t,function(t){return void 0!==t&&null!==t&&!0===t.locked}).length},traverseChildren:function(t,e){var n=this,i="";return t.children&&_.each(t.children,function(t){i+=n.traverseChildren(t,e)}),n.stringifyItem(t,e)+i},stringifyItem:function(t,e){for(var n=1,i="",a=t.parent,r=this;t.depth>n;)a=a.parent,i+=",",n+=1;if(t.depth>0){for(i+=t.data.record.get("FormattedID"),n=a.height-t.depth;n>0;)i+=",",n-=1;i+=","+this._getFieldTextAndEscape(t.data.record.data.Name),_.each(e,function(e){i+=","+r._getFieldTextAndEscape(t.data.record.data[e])}),_.contains(this.fields,"Attachments")&&(i+=","+(t.data.Attachments?t.data.Attachments.Count:0),i+=","+(t.data.Attachments?t.data.Attachments.Size:0),i+=","+t.ChildAttachments.Size),console.log(i)}return i+"\n"},_getCSV:function(t){var e="",n="",a=["Attachments"],r=_.filter(this.fields,function(t){return!_.contains(a,t)});if(t){for(i=0;i<t.height;i++)n+="Ring "+i+",";if(n+="Name",_.each(r,function(t){n+=","+t}),_.contains(this.fields,"Attachments")&&(n+=",Attachments Count, Attachments Size, Attachments Total"),n+="\n",e=this.traverseChildren(t,r)+e,t.ChildAttachments.Count>0){for(i=0;i<t.height;i++)e+=",";for(e+="Total Attachments Size",i=0;i<r.length;i++)e+=",";e+=","+t.ChildAttachments.Count+","+t.ChildAttachments.Size+"\n"}return e.length>0?n+e:null}}});
                function worker(){var e="true";function s(s){var a=new XMLHttpRequest;return a.onreadystatechange=t,a.withCredentials=!0,"Reading",a.open("GET",s+"?fetch="+e,!0),a.send(null),!0}function t(e){4===this.readyState&&200===this.status&&(!function(e){postMessage({response:"Alive",reply:"Data",records:e,id:this.id})}(JSON.parse(this.responseText).QueryResult.Results),"Asleep")}function a(){postMessage({response:"Alive",reply:this.currentState,id:this.id})}onmessage=function(t){switch(t.data.command){case"wake":a();break;case"initialise":this.id=t.data.id,"Asleep",e=encodeURIComponent(t.data.fields.toString()),a();break;case"readchildren":!function(e){if((null!==e.hasChildren&&s(e.hasChildren))+(null!==e.hasStories&&s(e.hasStories))+(null!==e.hasDefects&&s(e.hasDefects))+(null!==e.hasTasks&&s(e.hasTasks))+(null!==e.hasTestCases&&s(e.hasTestCases)))return;a()}(t.data);break;default:console.log("Unknown message received by thread: ",this.id)}}}

            Rally.launchApp('Niks.Apps.listExporter.app', {
                name:"custom-list-with-export",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
